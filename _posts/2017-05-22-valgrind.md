---
layout: post
title: 'Debugging C programs with Valgrind'
category: programming
tags: ['environment', 'c']
external_links:
    - title: 'Valgrind official site'
      link: http://valgrind.org
---

Recently after adding and releasing a new feature to [the fastq filterer used at Edinburgh Genomics](https://github.com/EdinburghGenomics/Fastq-Filterer), we got unexpected segfaults when running the program on full-size input data. The problem did not occur on minimal test data or when we tried truncating the input files, making us think we were mishandling memory somewhere - very possible, since I'm still fairly new to programming in C. To find out what was going wrong, I used a piece of software called Valgrind.

While it may initially appear complicated, basic usage of Valgrind is very simple. It was even on Homebrew for development on Mac OSX:

    brew install valgrind

You can then attach Valgrind simply by prepending it to the command line you would normally use to run your program:

    valgrind <valgrind_args> ./program <program_args>

By default, Valgrind will run a tool called [Memcheck](http://valgrind.org/docs/manual/mc-manual.html), which will look for any dodgy memory management in your program as it runs, and produce a report. With the right arguments, you can report on memory leaks, how many bytes of memory are affected, where they occur in the stack, etc. This not only helped me correct an `malloc` call (embarrassingly, I'd neglected to add 1 to account for a '\0' null terminator), but also taught me some of the nuances of `strtok`, which I was using to walk along a string (in brief, it returns a pointer to a segment of the string you pass in, so you need to make sure you don't free the string until you're completely finished with it).

For something that deals with such a complex system, Valgrind turned out to be easy to use, flexible, and reasonably clear and informative. Why can't [GDB](https://www.gnu.org/software/gdb) be like this?
